# 操作系统第三次实验 - 键盘输入与回显

## 问题清单

1. ### 解释中断向量

   把中断/异常与相应的处理方法对应起来

   每种中断都会对应一个中断向量号，而这个向量号通过IDT（中断向量表）就与相应的中断处理程序对应起来了。

2. ### 解释中断类型码

   把每个中断服务程序进行编号，这个号就代表一个中断服务程序，就是中断类型码；用于查找中断向量。  

3. ### 解释中断向量表

   中断向量表是指中断服务程序入口地址的偏移量与段基址，一个中断向量占据4字节空间。中断向量表是8086系统内存中最低端1K字节空间，它的作用就是按照中断类型号从小到大的顺序存储对应的中断向量，总共存储256个中断向量。

4. ### 实模式下中断程序地址如何得到?

   根据中断类型码n，从中断向量表中取得中断处理程序地址，取得的段地址存入CS，偏移量存入IP。

5. ### 保护模式下中断程序地址如何得到?

   保护模式下的中断过程则较为复杂，它要借助中断门描述符来获取中断子程序这个目标段的描述符，也就是说必须经过两次查表才能获得中断服务子程序的入口地址

   装载中断描述符表寄存器CPU切换到保护模式之前，运行于实模式下的初始化程序必须使用LIDT指令装载中断描述符表IDT，将IDT基地址与段界值装入IDTR。如果不完成这一步操作，系统就会100%崩溃。在返回实模式或系统复位时，IDTR中自动装入000000H的基地址值与03FFH的段界值。可见实模式的中断向量表是固定在存储器的最底部，而保护模式下的IDT则是可以改变的。 

6. ### 中断向量的地址如何得到?

   中断类型号×4=存放中断向量的首地址

   按照实模式的寻址方式找到对应的中断处理的入口

7. ### 实模式下如何根据中断向量的地址得到中断程序地址?

   根据中断向量地址倒推出中断类型码，然后根据中断类型码n，从中断向量表中取得中断处理程序地址，取得的段地址存入CS，偏移量存入IP。

8. ### 解释中断描述符

   在保护模式下，为每一个中断和异常定义了一个中断描述符，来说明中断和异常服务程序的入口地址的属性。

   其实就类似于中断向量，把中断、异常和对应的入口地址联系起来。

9. ### 保护模式下中断描述符表如何得到?

   引入一个48位的全地址寄存器（即中断描述符表寄存器IDTR）存放IDT的内存地址。

10. ### 保护模式下中断门如何得到?

    查中断描述符表以IDTR指定的中断描述符表的基地址为起始地址，用调用号N×8算出偏移量，即为N号中断门描述符的首地址，由此处取出中断门的8个字节

11. ### 保护模式下如何根据中断门得到中断处理程序地址?

    查全局或局部描述符表根据中断门中的选择子（段选择符）和偏移量得到中断处理程序入口

12. ### 中断的分类，举例不同类型的中断?

    #### 从中断源的角度分类：

    由计算机硬件异常或故障引起的中断，也称为**内部异常中断**。

    由程序中执行了中断指令引起的中断，也称为**软中断**。由程序员通过INT或INT3指令触发，通常当做trap处理，用于实现系统调用。

    外部设备（如输入输出设备）请求引起的中断，也称为**外部中断或IO中断**。

    #### 中断和异常的区别（与下一题相似）：

    由CPU以外的事件引起的中断：狭义的中断

    来自CPU的内部事件或程序执行中的事件引起的过程：异常

13. ### 中断与异常的区别?

    由CPU以外的事件引起的中断：时钟中断、IO中断

    来自CPU的内部事件或程序执行中的事件引起的过程：CPU异常、系统调用

14. ### 实模式和保护模式下的中断处理差别

    保护模式下的中断处理与实模式下的中断处理最大区别在于寻找中断处理代码入口的方式

    在保护模式下，为每一个中断和异常定义了一个中断描述符，来说明中断和异常服务程序的入口地址的属性

    由中断描述符表取代实地址模式下的中断向量表

15. ### 如何识别键盘组合键(如Shift+a) 是否还有其他解决方案?

    用make code + break code。这个在写JS的时候一直在用。

16. ### IDT 是什么，有什么作用?

    中断描述符表，用于取代实地址模式下的中断向量表来寻找中断向量的始地址。

    ![__XOPZM`SYLDSJB9B1O_1_L.png](https://i.loli.net/2019/11/25/UenZyLxwuvS6AYM.png)

17. ### IDT 中有几种描述符?

    3种，任务门、中断门和自陷门。

18. ### 异常的分类?

    故障(fault)：是有意而为之的异常，是明知有套还往里钻——人家要的就是这个结果，其最常见的用途就是操作系统的系统调用。通常可以被纠正。eip中保存的是引起故障的指令地址。纠正后会重新执行该条指令。 

    陷阱(trap)：如果可以修复，则啥事儿没有，继续干活；如果不能修复则会转化为终止，并进入下一步。常见的故障如缺页。eip保存的是随后要执行的指令地址。只有当没有必要重新执行已终止的指令时(通常为了调试程序)时才触发陷阱

    异常中止(abort)：是不可恢复的致命的错误造成结果。终止处理程序不再将控制返回给引发终止的应用程序，而是交给了系统——其结果往往是系统终止应用程序。不能在eip中保存引起异常的指令所在的确切位置。用于报告严重的错误。

19. ### 用户态和内核态的特权级分别是多少?

    用户态的特权级是3，内核态的特权级是0。

20. ### 中断向量表中，每个中断有几个字节? 里面的结构是什么?

    4字节。低地址两个字节放偏移，高地址两个字节放段描述符。

21. ### 中断异常共同点(至少两点)，不同点(至少三点)

    #### 共同点

    - 都是程序执行过程中的强制性转移，转移到相应的处理程序。

    - 都是软件或者硬件发生了某种情形而通知处理器的行为。

    #### 不同点

    - ##### 定义不同

      中断，是CPU所具备的功能。通常因为“**硬件**”而随机发生。

      异常，是“**软件**”运行过程中的一种开发过程中没有考虑到的程序错误。

    - ##### 运行状态不同

      中断是CPU暂停当前工作，**有计划**地去处理其他的事情。中断的发生一般是**可以预知**的，处理的过程也是事先制定好的。处理中断时程序是**正常运行**的。

      异常是CPU遇到了无法响应的工作，而后进入一种**非正常**状态。异常的出现表明程序**有缺陷**。

    - ##### 通信方式不同

      中断是来自处理器外部的I/O设备的信号的结果，它不是由指令流中某条指令执行引起的，从这个意义上讲，它是**异步**的，是来自指令流之外的。

      异常是执行当前指令流中的某条指令的结果，是来自指令流内部的，从这个意义上讲它们都是**同步**的。

    - ##### 返回点不同

      良性的如中断和trap，只是在正常的工作流之外执行额外的操作，然后继续干没干完的活。因此处理程序完了后返回到原指令流的下一条指令，继续执行。

      恶性的如fault和abort，对于可修复fault，由于是在上一条指令执行过程中发生（是由正在执行的指令引发的）的，在修复fault之后，会重新执行该指令；至于不可修复fault或abort，则不会再返回。

    - ##### 产生位置一般不同

      中断是由于当前程序无关的中断信号触发的，CPU对中断的响应是被动的，且与CPU模式无关。既可以发生在用户态，又可以发生在核心态。

      异常是由CPU控制单元产生的，大部分异常发生在用户态。